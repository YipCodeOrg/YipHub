<!DOCTYPE html>
<html>
    <head>
        <style id="frameBreaker">
            body{display:none !important;}
        </style>
        <script type="text/javascript" src="../env.js"></script>            
        <script type="text/javascript">
            'use strict';

            const yipFrontOrigin = env.yipFrontOrigin

            if (window != top && window.parent === top) {
                var frameBreaker = document.getElementById("frameBreaker");
                frameBreaker.parentNode.removeChild(frameBreaker);
                document.addEventListener("DOMContentLoaded", init);                
            } else {
                throw new Error("Invalid framing context detected.")
            }

            function init(){
                const fromFrontChannel = new MessageChannel();
                fromFrontChannel.port1.onmessage = handleFrontMessage                    
                console.log("Hub ready to listen. Posting status...")
                window.top.postMessage("readyToListen", yipFrontOrigin, [fromFrontChannel.port2])  
                console.log("...Posted status: Hub ready to listen.")
            }
            
            //////////////////////////////// HANDLE: MAIN

            const loginRequestLabel = "requestLoginStatus"
            const apiRequestLabel = "apiRequest"

            function handleFrontMessage(msgEvent) {           
                const data = msgEvent.data;
                if(!isLabelValid(data)){
                    throw new Error("Bad message data - invalid or missing label.")
                }
                const label = data.label
                const responsePort = msgEvent.ports[0]
                console.log(`Message received from Front. Processing: ${label}...`);
                switch (label) {
                    case loginRequestLabel:
                        handleLoginRequest(responsePort)
                        break;
                    case apiRequestLabel:
                        if(!isValidApiRequest(data)){
                            throw new Error("Bad message data - invalid API request.")                            
                        }
                        const payload = extractApiRequestPayload(data)
                        if(!!payload.body){
                            handleApiRequestWithBody(responsePort, payload)
                        }
                        else{
                            handleApiRequestWithoutBody(responsePort, payload)
                        }           
                        break;
                    default:
                        const errorMsg = "Unhandled message data received from Front";
                        throw new Error(errorMsg);
                }
                console.log(`...finished processing message from Front: : ${label}`);
            }

            //////////////////////////////// HANDLE: LOGIN

            function handleLoginRequest(responsePort){
                console.log("Posting login status from Hub...")
                const isLoggedIn = !!localStorage.getItem("access_token")
                const status = isLoggedIn ? "userIsLoggedIn" : "userNotLoggedIn"
                responsePort.postMessage({label: status})
                console.log("...Hub finished posting login status")
            }

            //////////////////////////////// HANDLE: API-REQUEST

            const HttpStatusOk = BigInt(200)
            const apiResponseLabel = "apiResponse"

            const getMethod = "GET"
            const allowedMethods = [getMethod]

            function handleApiRequestWithBody(responsePort, requestPayload){
                throw new Error("Not Implemented")
            }

            function handleApiRequestWithoutBody(responsePort, requestPayload){
                const method = requestPayload.method
                const path = requestPayload.path
                //TODO: Refactor this to do a safelist check on method/path combo & then send off to API-G
                //Make sure you
                if(method === getMethod && path === "/yipcodes"){
                    setTimeout(() => responsePort.postMessage({label: apiResponseLabel, payload:{status: HttpStatusOk, body: ["Yc1, Yc2, Yc3"]}}), 1000)
                } else{
                    throw new Error("Unhandled request method/path combination")
                }                
            }

            //////////////////////////////// SANITIZATION

            function isLabelValid(unsafeData){
                if(!isSimpleProperty(unsafeData, "label")){
                    return false
                }
                const label = unsafeData.label
                return isString(label)
            }

            function extractApiRequestPayload(data){
                const payload = data.payload
                if(!!payload.body){
                    return {
                        method: payload.method,
                        path: payload.path,
                        body: payload.body
                    }
                }
                return {
                    method: payload.method,
                    path: payload.path,                
                }
            }

            function isValidApiRequest(unsafeData){
                if(!isSimpleProperty(unsafeData, "payload")){
                    return false
                }
                const unsafePaylod = unsafeData.payload
                let expectedStringProperties = ["method", "path"]
                const bodyStr = "body"
                if(isProperty(unsafeData, bodyStr)){
                    expectedStringProperties.push(bodyStr)
                }
                if(!areSimpleProperties(unsafePaylod, expectedStringProperties)){
                    console.log("Invalid API request: some expected simple properties not found")
                    return false
                }
                if(!areStrings(expectedStringProperties)){
                    console.log("Invalid API request: some properties are not strings")
                    return false
                }
                if(!allowedMethods.includes(unsafePaylod.method)){
                    console.log("Invalid API request: Invalid method")
                    return false
                }
                return true
            }

            function areSimpleProperties(obj, properties){
                for(const prop of properties){
                    if(!isSimpleProperty(obj, prop)){
                        return false
                    }
                }
                return true
            }

            function isProperty(obj, property){
                return !!Object.getOwnPropertyDescriptor(obj, property)
            }

            function isSimpleProperty(obj, property){
                const desc = Object.getOwnPropertyDescriptor(obj, property)
                if(!!desc){
                    if(!desc.get && !desc.set){
                        return true
                    }
                }
                return false
            }

            function areStrings(objs){
                for(const obj of objs){
                    if(!isString(obj)){
                        return false
                    }
                }
                return true
            }

            function isString(obj){
                return (typeof obj === 'string' || obj instanceof String)
            }

        </script>            
    </head>
</html>