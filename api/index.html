<!DOCTYPE html>
<html>
    <head>
        <style id="frameBreaker">
            body{display:none !important;}
        </style>
        <script type="text/javascript" src="../env.js"></script>            
        <script type="text/javascript">
            'use strict';

            const yipFrontOrigin = env.yipFrontOrigin

            if (window != top && window.parent === top) {
                var frameBreaker = document.getElementById("frameBreaker");
                frameBreaker.parentNode.removeChild(frameBreaker);
                document.addEventListener("DOMContentLoaded", init);                
            } else {
                throw new Error("Invalid framing context detected.")
            }

            function init(){
                const fromFrontChannel = new MessageChannel();
                fromFrontChannel.port1.onmessage = handleFrontMessage                    
                console.log("Hub ready to listen. Posting status...")
                window.top.postMessage("readyToListen", yipFrontOrigin, [fromFrontChannel.port2])  
                console.log("...Posted status: Hub ready to listen.")
            }
            
            //////////////////////////////// HANDLE: MAIN

            function handleFrontMessage(msgEvent) {           
                const data = msgEvent.data;
                if(!isLabelValid(data)){
                    throw new Error("Bad message data - invalid or missing label.")
                }
                const label = data.label
                const responsePort = msgEvent.ports[0]
                console.log(`Message received from Front. Processing: ${label}...`);
                switch (label) {
                    case "requestLoginStatus":
                        handleLoginRequest(responsePort)
                        break;
                    case "apiRequest":
                        if(!isValidApiRequest(data)){
                            throw new Error("Bad message data - invalid API request.")                            
                        }
                        handleApiRequest(responsePort, data.payload)
                    default:
                        const errorMsg = "Unhandled message data received from Front";
                        throw new Error(errorMsg);
                }
                console.log("...finished processing message from Front.");
            }

            function isLabelValid(unsafeData){
                const label = unsafeData.label
                return (typeof label === 'string' || label instanceof String)
            }

            function isValidApiRequest(unsafeData){
                //TODO           
            }

            //////////////////////////////// HANDLE: CASES

            function handleLoginRequest(responsePort){
                console.log("Posting login status from Hub...")
                const isLoggedIn = !!localStorage.getItem("access_token")
                const status = isLoggedIn ? "userIsLoggedIn" : "userNotLoggedIn"
                responsePort.postMessage({label: status})
                console.log("...Hub finished posting login status")
            }

            //////////////////////////////// HANDLE: API-REQUEST

            function handleApiRequest(responsePort, requestPayload){
                //TODO
            }

        </script>            
    </head>
</html>