<!DOCTYPE html>
<html>
    <head>
        <script type="text/javascript" src="../env.js"></script>            
        <script type="text/javascript">
            'use strict';

            //TODO: Add some frame-breaking code to ensure this is only embedded in yipFrontOrigin page

            document.addEventListener("DOMContentLoaded", init);
            window.addEventListener("message", handleFrontMessage);
            
            const yipFrontOrigin = env.yipFrontOrigin

            function init(){
                postReadyToListen()
            }

            //////////////////////////////// POST

            function postReadyToListen(){
                console.log("Hub ready to listen. Posting status...")
                postFrontMessage("readyToListen")
                console.log("...Posted status: Hub ready to listen.")
            }

            function postLoginStatus(){
                console.log("Posting login status from Hub...")
                const isLoggedIn = !!localStorage.getItem("access_token")
                const status = isLoggedIn ? "userIsLoggedIn" : "userNotLoggedIn"
                postFrontMessage(status)
                console.log("...Hub finished posting login status")
            }

            function postFrontMessage(msg){
                window.top.postMessage(msg, yipFrontOrigin)
            }
            
            //////////////////////////////// HANDLE

            function handleFrontMessage(msgEvent) {                
                if(msgEvent.origin != yipFrontOrigin){
                    throw "Origin mismatch. Will not process message."
                }
                const data = msgEvent.data;
                let postHandleMsg = "Processed message from Front: ";
                switch (data) {
                    case "requestLoginStatus":
                        postHandleMsg += "Login status requested";
                        postLoginStatus()
                        break;
                    default:
                        const errorMsg = "Unhandled message data received from Front";
                        postHandleMsg += `ERROR ${errorMsg}`;
                        throw new Error(errorMsg);
                }
                console.log(postHandleMsg);
            }

        </script>            
    </head>
</html>