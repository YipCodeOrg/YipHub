<!DOCTYPE html>
<html>
    <head>
        <style id="frameBreaker">
            body{display:none !important;}
        </style>
        <script type="text/javascript" src="../env.js"></script>            
        <script type="text/javascript">
            'use strict';

            const yipFrontOrigin = env.yipFrontOrigin

            if (window != top && window.parent === top) {
                var frameBreaker = document.getElementById("frameBreaker");
                frameBreaker.parentNode.removeChild(frameBreaker);
                document.addEventListener("DOMContentLoaded", init);
                window.addEventListener("message", handleFrontMessage);
            } else {
                throw new Error("Invalid framing context detected.")
            }

            function init(){
                postReadyToListen()
            }

            //////////////////////////////// POST

            function postReadyToListen(){
                console.log("Hub ready to listen. Posting status...")
                postFrontMessage("readyToListen")
                console.log("...Posted status: Hub ready to listen.")
            }

            function postLoginStatus(){
                console.log("Posting login status from Hub...")
                const isLoggedIn = !!localStorage.getItem("access_token")
                const status = isLoggedIn ? "userIsLoggedIn" : "userNotLoggedIn"
                postFrontMessage(status)
                console.log("...Hub finished posting login status")
            }

            function postFrontMessage(msg){
                window.top.postMessage(msg, yipFrontOrigin)
            }
            
            //////////////////////////////// HANDLE

            function handleFrontMessage(msgEvent) {                
                if(msgEvent.origin != yipFrontOrigin){
                    throw "Origin mismatch. Will not process message."
                }
                const data = msgEvent.data;
                const label = data.label
                let postHandleMsg = "Processed message from Front: ";
                switch (label) {
                    case "requestLoginStatus":
                        postHandleMsg += "Login status requested";
                        postLoginStatus()
                        break;
                    default:
                        const errorMsg = "Unhandled message data received from Front";
                        postHandleMsg += `ERROR ${errorMsg}`;
                        throw new Error(errorMsg);
                }
                console.log(postHandleMsg);
            }

        </script>            
    </head>
</html>