<!DOCTYPE html>
<html>
    <head>
        <script type="text/javascript" src="../../env.js"></script>            
        <script type="text/javascript">
            'use strict';

            document.addEventListener("DOMContentLoaded", completePkceFlow);

            const sanitizedUrlParams = new Proxy(new URLSearchParams(window.location.search), {
                get(searchParams, prop){
                    if (prop === "code") {
                        return encodeURIComponent(searchParams.get("code"))
                    }
                    //TODO: Add state param
                    throw "Failed to process unrecognised URL parameter"
                }
            });

            const code = sanitizedUrlParams.code
            const encodedSelfUrl = encodeURIComponent(window.location.protocol + '//' + window.location.host + window.location.pathname)

            const tokenUrl = `${env.cognitoOrigin}/oauth2/token`

            async function completePkceFlow() {
                console.log("Exchanging code for tokens...");
                await exchangeCodeForTokens()
                console.log("...Code exchanged for tokens");            
            }

            async function exchangeCodeForTokens()
            {
                const {
                    access_token,
                    refresh_token,
                    id_token,
                    error,
                } = await fetch
                (
                    tokenUrl, 
                    {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: Object.entries({
                            "grant_type": "authorization_code",
                            "client_id": env.cognitoClientId,
                            "code": code,
                            "redirect_uri": encodedSelfUrl,
                        }).map(([k, v]) => `${k}=${v}`).join("&"),
                    }
                ).then(res => res.json())

                if(error){
                    throw new Error(error)
                }

                localStorage.setItem("access_token", access_token)
                localStorage.setItem("refresh_token", refresh_token)
                localStorage.setItem("id_token", id_token)
            }

        </script>            
    </head>
</html>