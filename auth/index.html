<!DOCTYPE html>
<html>
    <head>
        <script type="text/javascript" src="../env.js"></script>            
        <script type="text/javascript">
            'use strict';

            async function test() {
                console.log(`Enviornment: ${env.environment}`);
                //TODO: SANITIZE INPUTS!
                console.log(`URL params: ${window.location.search}`);
                const nonce = await generateRandomHexString(); 
                const base64UrlEncodedHash = base64URLEncode(await sha256(nonce)); 
                console.log("Nonce:", nonce); 
                console.log("Base64 URL encoded hash:", base64UrlEncodedHash); 
            }

            document.addEventListener("DOMContentLoaded", test);

            const sha256 = async (str) => { 
                const encoded = new TextEncoder().encode(str)
                return await crypto.subtle.digest("SHA-256", encoded); 
            };

            const generateRandomHexString = async () => { 
                const seedVals = crypto.getRandomValues(new Uint32Array(4))
                const seedString = seedVals.toString()
                const hashBuffer = await sha256(seedString); 
                const bufferCopyByteArray = new Uint8Array(hashBuffer)
                const untypedByteArray = Array.from(bufferCopyByteArray); 
                const hexPairsArray = untypedByteArray.map((b) => b.toString(16).padStart(2, "0"))
                const randomString = hexPairsArray.join("")
                return randomString; 
            }; 
  
            const base64URLEncode = (arrayBuffer) => { 
                const byteArray = new Uint8Array(arrayBuffer)
                const binaryByteString = String.fromCharCode(...byteArray)
                const asciiBase64String = btoa(binaryByteString)
                return asciiBase64String
                    .replace(/\+/g, "-") 
                    .replace(/\//g, "_") 
                    .replace(/=+$/, ""); 
            }; 

        </script>            
    </head>
</html>