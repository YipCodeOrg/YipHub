<!DOCTYPE html>
<html>
    <head>
        <script type="text/javascript" src="../../env.js"></script>            
        <script type="text/javascript">
            'use strict';

            const sanitizedUrlParams = new Proxy(new URLSearchParams(window.location.search), {
                get(searchParams, prop){
                    if (prop === "action") {
                        return searchParams.get("action") == 'signup' ? 'signup' : 'login'
                    }
                    throw "Failed to process unrecognised URL parameter"
                }
            });

            const action = sanitizedUrlParams.action

            const callbackUrlEncoded = encodeURIComponent(`${env.selfOrigin}/auth/handle/index.html`)
            
            const callCognitoUrl = `${env.cognitoOrigin}/${action}?client_id=${env.cognitoClientId}&response_type=code&scope=openid&redirect_uri=${callbackUrlEncoded}`

            async function test() {
                console.log(`Callback URL: ${callbackUrlEncoded}`);
                console.log(`Enviornment: ${env.environment}`);
                console.log(`Action: ${action}`);
                const nonce = await generateRandomHexString(); 
                const base64UrlEncodedHash = base64URLEncode(await sha256(nonce)); 
                console.log("Nonce:", nonce); 
                console.log("Base64 URL encoded hash:", base64UrlEncodedHash);
                console.log("Redirecting to Cognito...");
                window.location = callCognitoUrl
            }

            document.addEventListener("DOMContentLoaded", test);

            const sha256 = async (str) => { 
                const encoded = new TextEncoder().encode(str)
                return await crypto.subtle.digest("SHA-256", encoded); 
            };

            const generateRandomHexString = async () => { 
                const seedVals = crypto.getRandomValues(new Uint32Array(4))
                const seedString = seedVals.toString()
                const hashBuffer = await sha256(seedString); 
                const bufferCopyByteArray = new Uint8Array(hashBuffer)
                const untypedByteArray = Array.from(bufferCopyByteArray); 
                const hexPairsArray = untypedByteArray.map((b) => b.toString(16).padStart(2, "0"))
                const randomString = hexPairsArray.join("")
                return randomString; 
            }; 
  
            const base64URLEncode = (arrayBuffer) => { 
                const byteArray = new Uint8Array(arrayBuffer)
                const binaryByteString = String.fromCharCode(...byteArray)
                const asciiBase64String = btoa(binaryByteString)
                return asciiBase64String
                    .replace(/\+/g, "-") 
                    .replace(/\//g, "_") 
                    .replace(/=+$/, ""); 
            }; 

        </script>            
    </head>
</html>